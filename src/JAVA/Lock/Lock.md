# 锁

## 锁的内存语义
  
  * **内存可见性**：同步块的可见性是由“如果对一个变量执行lock操作，将会清空工作内存中此变量的值，在执行引擎使用这个变量前需要重新执行load或assign操作初始化变量的值”、“对一个变量执行unlock操作之前，必须先把此变量同步回主内存中（执行store和write操作）”这两条规则获得的。
  * **操作原子性**：持有同一个锁的两个同步块只能串行地进入
  
  ### 锁的内存语义：
  
  * 当线程释放锁时，JMM会把该线程对应的本地内存中的共享变量刷新到主内存中
  * 当线程获取锁时，JMM会把该线程对应的本地内存置为无效。从而使得被监视器保护的临界区代码必须从**主内存中**读取共享变量
  ### 锁释放和锁获取的内存语义：
  
  * 线程A释放一个锁，实质上是线程A向接下来将要获取这个锁的某个线程发出了（线程A对共享变量所做修改的）消息。
  * 线程B获取一个锁，实质上是线程B接收了之前某个线程发出的（在释放这个锁之前对共享变量所做修改的）消息。
  * 线程A释放锁，随后线程B获取这个锁，这个过程实质上是线程A通过主内存向线程B发送消息
  
 ![image.png](https://pic1.zhimg.com/80/v2-9b408e5de9536f47d32db62bb269a9a8_720w.jpg)

